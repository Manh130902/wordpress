# CVE-2023-3460

- Plugin : Ultimate Member
- Phiên bản lỗi : 2.6.5
- Lỗi : Unauthenticated Privilege Escalation
- CVSS Score: 9.8 (CRITICAL)

# Mô tả

- Ultimate Member là một plugin WordPress phổ biến cung cấp bộ tính năng toàn diện để đăng ký, đăng nhập và quản lý hồ sơ người dùng. Nó được sử dụng rộng rãi bởi các trang web để tạo cộng đồng người dùng và trang web thành viên mạnh mẽ. Plugin có hơn 200.000 lượt cài đặt đang hoạt động.
  
![image](https://github.com/Manh130902/wordpress/assets/93723285/5039b41e-f0fd-4f1f-9020-c97c57fdd90b)

# Hàm xử lý bị lỗi

- Trước khi tìm hiểu về hàm xử lý lỗi thì chúng ta cần phải biết trong wordpress chia ra làm rất nhiều các vai trò khác nhau như Super Admin, Administrator, Editor, Authorvà Contributor.
![image](https://github.com/Manh130902/wordpress/assets/93723285/d132f570-e1d3-4e87-82bc-5ba94e4e2fe1)

- Bây giờ, hãy đi sâu vào phần phụ trợ để hiểu hoạt động của nó. Tôi đã đăng ký hai người dùng với vai trò là Administrator và Subscriber . Nếu chúng ta kiểm tra bảng wp_usermeta trong MySQL , chúng ta sẽ thấy rằng giá trị wp_capabilities được đặt thành một mảng được tuần tự hóa , xác định vai trò của chúng ta lần lượt là:
![image](https://github.com/Manh130902/wordpress/assets/93723285/8121c8b0-5589-40b9-9c2b-ce7b0a91096b)
![image](https://github.com/Manh130902/wordpress/assets/93723285/1e543ede-ddc4-4a58-8df5-850379d41350)

- Ta chỉnh thử tạo 1 tài khoản và cố tình chỉnh sửa giá trị wp_capabilities nhưng không được lý do là vì có một hàm có tên is_metakey_banned hoạt động bằng cách kiểm tra các giá trị khác nhau như "cap_key", "wp_capabilities", "wp_user_level", "user_activation_key", v.v. Tuy nhiên, chúng ta sẽ chú ý đến wp_capabilities. Nếu chúng ta đưa nó vào nội dung yêu cầu của mình, thì hàm sẽ vi phạm và nhảy vào break, ngăn chúng ta thay đổi vai trò của mình.
![image](https://github.com/Manh130902/wordpress/assets/93723285/fef852f6-10d6-4df1-8148-fdfd29fe9675)

- Nhưng có 1 điểm rất thú vị đó là WordPress chấp nhận các ký tự có dấu như: à, è, ì, ò, ù, À, È, Ì, Ò, Ù. Bây giờ, nếu chúng ta sử dụng những ký tự này trong nội dung request gửi đi chẳng hạn như , wp_càpabilities=administrator , thì yêu cầu sẽ không vi phạm dẫn đến không chạm đến điểm ngắt trên dòng 182 trong class-user.php, và điều này cho phép chúng ta bỏ qua hàm is_metakey_banned.

# Khai thác

- Khi ta bắt yêu cầu đăng ký 1 tài khoản và chỉnh sửa giá trị wp_capabilities=administrator
![image](https://github.com/Manh130902/wordpress/assets/93723285/57be3e00-5fc4-43e9-8cb0-0e3081cd3e37)

- Đã đăng ký thành công như ta không được gán bất kỳ một role nào cả
![image](https://github.com/Manh130902/wordpress/assets/93723285/0be0c62e-3a34-47c2-be40-c37e46b6f423)

- Kiểm tra bảng wp_usermeta ta thấy giá trị là administrator nhưng với giá trị này thì ta cũng không được cấp quyền admin
![image](https://github.com/Manh130902/wordpress/assets/93723285/3abb745a-e24d-485d-83d8-56f88f001921)

- Ta thay đổi giá trị thành giá trị của admin mà ta biết được ở bảng wp_usermeta mà lúc trước ta tạo xem kết quả:
![image](https://github.com/Manh130902/wordpress/assets/93723285/c811cacc-acb9-4043-a276-69f1f0b9d7e4)

- Kiểm tra bảng wp_usermeta ta thấy giá trị không như như chúng ta mong muốn, giá trị đã bị thay đổi thành:
![image](https://github.com/Manh130902/wordpress/assets/93723285/ce9548ac-4a1b-4809-a778-653b63bd4321)

- Vì vậy khi kiểm tra thì chũng ta vẫn chưa được cấp quyền admin
![image](https://github.com/Manh130902/wordpress/assets/93723285/8e899397-83d6-434f-873c-7bfa2c944727)

- Sau một hồi tra cứu thì tôi đã tìm ra giá trị đúng phải là wp_càpabilities[administrator]=1 vì WordPress có cơ chế tuần tự hóa riêng , vì vậy tôi có thể chuyển giá trị của mình dưới dạng một mảng và WordPress sẽ xử lý quá trình tuần tự hóa cho tôi. Do đó, tải trọng của chúng tôi phải được định dạng là wp_càpabilities[administrator]=1. Bằng cách cung cấp nó theo cách này, WordPress sẽ diễn giải chính xác mảng và cấp cho tôi vai trò quản trị viên.
![image](https://github.com/Manh130902/wordpress/assets/93723285/17f994b0-4c80-4e2a-b3f1-eafcfc17134d)

- Sau khi thực hiện những thay đổi cần thiết, chúng ta có thể nhận thấy rằng giá trị của wp_capabilities đã được sửa đổi thành a:1:{s:13:"administrator";s:1:"1";}. Với giá trị này thì tôi có thể đăng nhập với tư cách quản trị viên , cấp các đặc quyền liên quan đến vai trò quản trị viên.
![image](https://github.com/Manh130902/wordpress/assets/93723285/eb201389-bdb8-4b0d-9c2f-795ce82d3ae0)
