# CVE-2023-23488

- Plugin : Paid Memberships Pro
- Phiên bản lỗi: <2.9.8
- Lỗi : Unauthenticated Blind time-based SQLi

# Mô tả

- Paid Memberships Pro (PMPro) là một plugin WordPress được sử dụng để tạo và quản lý các khách hàng trả phí trên trang web của bạn. Plugin này cung cấp một loạt các tính năng và chức năng để tạo và quản lý chương trình thành viên trả phí trên trang web của bạn.

# Hàm xử lý bị lỗi

- Sử dụng REST API của Wordpress được đăng ký theo router
  ![image](https://github.com/Manh130902/wordpress/assets/93723285/3176f175-719e-4f49-8967-62a1be2d3693)
- Nhảy vào function pmpro_rest_api_permissions_get_order() với
  ![image](https://github.com/Manh130902/wordpress/assets/93723285/457b73bf-52d2-4b90-9fdb-9cdf0c76cb1f)
  GET /?rest_route=/pmpro/v1/order HTTP/1.1
- Sau đó truyền thêm tham số code vào khởi tạo MemberOrder, nhảy trực tiếp đến \_\_construct
  ![image](https://github.com/Manh130902/wordpress/assets/93723285/a35010e6-09c0-49af-82e2-c6d7680a7c47)

- Ở đây ta truyền giá trị code không phải là số sẽ nhảy sang function getMemberOrderByCode($id)
  ![image](https://github.com/Manh130902/wordpress/assets/93723285/4d779e13-9639-4dd0-9e9e-adc62fdd581c)

- Tại đây giá trị code được truyền vào hoàn toàn không được filter hay escape gì, tại đây chúng ta có thể inject SQL vào đây theo kiểu TimeBased
  ![image](https://github.com/Manh130902/wordpress/assets/93723285/0407428f-86a5-48c4-8daf-08a3195392b3)

# Khai thác

- Bắt yêu cầu từ burp
  ![image](https://github.com/Manh130902/wordpress/assets/93723285/a46699da-8870-4def-959f-e617a5a8c099)

- Như đã thấy rằng giá trị $\_GET['code'] đã tự động thêm dấu \ từ đây ta không thể nào break ra khỏi dấu nháy đơn để thoát khỏi string
  NOTE: WordPress sẽ tự động xử lý và áp dụng addslashes() cho các giá trị này để đảm bảo rằng chúng an toàn khi được sử dụng trong các câu lệnh SQL hoặc các tình huống khác. Hàm được gọi lên ngay từ wp-setting.php
  ![image](https://github.com/Manh130902/wordpress/assets/93723285/0191b304-e5a7-49e8-99f0-d64cfbd8f153)

- Với ghi chú rõ ràng rằng sử dụng để escape cho wpdb
  ![image](https://github.com/Manh130902/wordpress/assets/93723285/b85c98cd-be0a-47c5-a903-af55e49e1a87)

![image](https://github.com/Manh130902/wordpress/assets/93723285/895885cf-3f7d-4fa2-86a5-302e7bf379d1)

- Với mọi $\_GET, $\_POST, $\_COOKIE, $\_SERVER khi truyền từ input người dùng thì đều sẽ bị thêm slash vào.
- Tuy nhiên, tại sao khi sử dụng REST API thì Wordpress lại xoá mất dấu slash đi. Chúng ta có thể break ra khỏi dấu nháy đơn, inject câu lệnh SQL tuỳ ý.
  ![image](https://github.com/Manh130902/wordpress/assets/93723285/ebaedfea-d519-484b-acfc-500cbfc127c2)

- Đoạn xử lý xóa dấu \
  ![image](https://github.com/Manh130902/wordpress/assets/93723285/bb90e49e-ae67-4196-8d18-46076b24cc22)

- Từ đó ta chèn payload timebased vào thấy thời gian phản hồi lớn hơn 1s
  ![image](https://github.com/Manh130902/wordpress/assets/93723285/25a551ac-5875-4b76-8e7b-7b5c62b96d3a)

# Khai thác bằng script

Mã khai thác
![image](https://github.com/Manh130902/wordpress/assets/93723285/1eec599e-5636-4946-8eb0-face147d2118)

1. Đầu tiên, mã này sử dụng thư viện Python requests để thực hiện các yêu cầu HTTP đến trang web mục tiêu.
2. Hàm get_request(target_url, delay="1") được định nghĩa để tạo và gửi yêu cầu HTTP để tận dụng lỗ hổng SQL Injection. Biến target_url là URL của trang web mục tiêu và delay là thời gian trễ mà bạn muốn chờ đợi trước khi nhận được phản hồi từ trang web.
3. Trong hàm get_request, một chuỗi payload được tạo ra để thực hiện lỗ hổng SQL Injection. Payload này sẽ thực hiện một truy vấn SQL SLEEP(delay) để tạo ra thời gian trễ. Điều này được thực hiện thông qua tham số code trong yêu cầu HTTP.
4. Mã này cũng sử dụng data để xác định tham số rest_route và code trong yêu cầu HTTP.
5. Đoạn mã kiểm tra xem trang web mục tiêu có bị lỗ hổng SQL Injection không bằng cách so sánh thời gian trễ của hai yêu cầu:
   • Yêu cầu đầu tiên gửi payload với delay là 1 giây.
   • Yêu cầu thứ hai gửi payload với delay là 2 giây. Nếu thời gian trễ của yêu cầu với delay 2 giây lớn hơn, điều này cho thấy có sự trễ trong việc thực thi truy vấn SQL, cho biết lỗ hổng SQL Injection.
6. Nếu lỗ hổng được tìm thấy, mã sẽ in ra thông báo cho biết trang web mục tiêu có lỗ hổng và cung cấp các hướng dẫn về cách sử dụng công cụ sqlmap để khai thác lỗ hổng này và truy cập dữ liệu cơ sở dữ liệu WordPress.
   Chạy PoC
   ![image](https://github.com/Manh130902/wordpress/assets/93723285/87567d95-cb84-40b2-907d-74b4ed69fde7)

- Khi đó ta check được là phiên bản đang dùng <2.9.8 và có thể khai thác được lỗ hổng này
- Sau đó sẽ xuất ra các câu lệnh SQLMap để tiếp tục dump được db của chúng ta
  B1: Dump bảng
  ![image](https://github.com/Manh130902/wordpress/assets/93723285/a09d0dab-415e-4452-a792-421ba340d3f7)
  ![image](https://github.com/Manh130902/wordpress/assets/93723285/c2db2f9e-ac78-4cc1-a1c3-8718018adac2)

B2: Dump cột trong bản wp_user
![image](https://github.com/Manh130902/wordpress/assets/93723285/6e365348-a838-487c-9987-1f5870d5a572)

B3: Dump giá trị của các cột trong bản wp_user
![image](https://github.com/Manh130902/wordpress/assets/93723285/f4d19656-6234-46a4-a960-e21b4fbc710c)
![image](https://github.com/Manh130902/wordpress/assets/93723285/50630fe1-c200-4624-830d-4b350736ea39)

# Sửa Lỗi
