# CVE-2023-30777

- Plugin : Advanced Custom Fields (ACF)
- Phiên bản lỗi : 6.1.5
- Lỗi : Authenticated Reflexed Cross-Site Scripting (XSS)

# Mô tả

- Advanced Custom Fields (ACF) cho phép bạn thêm các trường vào màn hình chỉnh sửa WP một cách nhanh chóng và dễ dàng chỉ bằng một vài nút bấm! Cho dù đó là điều gì đó đơn giản như thêm trường “tác giả” vào bài đăng đánh giá sách hay điều gì đó phức tạp hơn như nhu cầu dữ liệu có cấu trúc của trang web thương mại điện tử hoặc thị trường, ACF giúp việc thêm trường vào mô hình nội dung của bạn trở nên dễ dàng.

# Hàm xử lý bị lỗi

![image](https://github.com/Manh130902/wordpress/assets/93723285/736ca9fd-8331-4339-af94-87bb3b174267)

- Hàm admin_body_class được cấu hình để trở thành 1 trình xửa lý bổ sung cho điểm móc nối riêng của Wordpress. Điểm móc nối này kiểm soát và lọc các lớp CSS cho thẻ body chính trong khu vực admin
  ![image](https://github.com/Manh130902/wordpress/assets/93723285/b9223942-f252-4474-954d-f2a54c8777ce)

- xem xét sâu hơn hàm admin_body_class của WordPress, chúng ta có thể thấy rằng giá trị đầu ra của hook không được làm sạch đúng cách và được xây dựng trực tiếp trên trang HTML
  ![image](https://github.com/Manh130902/wordpress/assets/93723285/62729e64-c1ef-4be3-a1b8-05703b3be449)

- Do tình trạng đó, có một lỗ hổng XSS tiềm ẩn nếu trình xử lý hàm hook không xử lý đúng cách chuỗi class được trả về.
- Hãy quay lại với trình xử lý hàm hook, mã sẽ nối trực tiếp biến $this->view với biến $classes sẽ được trả về dưới dạng chuỗi lớp. Chúng tôi thực sự có thể kiểm soát hoàn toàn biến $this->view từ hàm current_screen
  ![image](https://github.com/Manh130902/wordpress/assets/93723285/a05a2d27-52ff-4dc8-9d7d-22688603f11f)

Việc dọn dẹp bằng cách sử dụng chức năng sanitize_text_field là không đủ để ngăn chặn XSS, vì chúng ta vẫn có thể sử dụng tải trọng DOM XSS.

# Khai thác

- PoC
  ![image](https://github.com/Manh130902/wordpress/assets/93723285/c4408263-d36a-4cee-9219-2db3c17efb81)

- Chạy PoC
  ![image](https://github.com/Manh130902/wordpress/assets/93723285/7912cff4-3914-4ab5-91f4-11fcfd245667)

- Copy và gửi đường dẫn cho nạn nhân
  ![image](https://github.com/Manh130902/wordpress/assets/93723285/01b0d24a-c68a-4cfc-a004-ec62a55139e8)

- Khi nạn nhân truy cập và đường dẫn thì sẽ thực thi đoạn script độc hại
- F12 ta thấy đoạn mã đã được chèn vào trong thẻ body
  ![image](https://github.com/Manh130902/wordpress/assets/93723285/1fc493f7-eded-4542-a21b-77206c074944)
